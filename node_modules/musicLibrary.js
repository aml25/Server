/*google music functions*/

/*
	Eventually I'd like to get this abstracted and formatting into my own JSON structure so that any Music Source could be plug and play.
*/

var playMusic = require("playmusic");
playMusic = new playMusic();

exports.initLibrary = function(config){
	playMusic.init(config.playmusic, function(err, response){
	if(err) console.error(err);
		console.log("starting a google play music session");
	});
}

exports.search = function(query, _callback){
	console.log("got a search for: " + JSON.stringify(query, null, 4));
	playMusic.search(query.query, 5, function(err, data){
		var data = data.entries.sort(function(a, b) { // sort by match score
			return a.score < b.score;
		});

		var artists = [];
		var albums = [];
		var tracks = [];

		for(var i=0;i<data.length;i++){
			switch(data[i].type){
				case '1': //track
					tracks.push(data[i].track);
					break;
				case '2': //artist
					artists.push(data[i].artist);
					break;
				case '3': //album
					albums.push(data[i].album);
					break;
			}
		}

		data = {
			artists: artists,
			albums: albums,
			tracks: tracks
		}

		_callback(data); //return the search results for the given query
	});
}

exports.getArtist = function(query, _callback){
	console.log("got an artist request for: " + JSON.stringify(query, null, 4));
	playMusic.getArtist(query.artistId, true, 4, 0, function(err, data){
		var artists = [];
		var albums = [];
		var tracks = [];

		artists.push(data);
		albums = data.albums;
		tracks = data.topTracks;

		data = {
			artists: artists,
			albums: albums,
			tracks: tracks
		}
		
		_callback(data);
	});
}

exports.getAlbum = function(query, _callback){
	console.log("got an album request for: " + JSON.stringify(query, null, 4));
	playMusic.getAlbum(query.albumId, true, function(err, data){
		var albums = [];
		var tracks = [];

		albums.push(data);
		tracks = data.tracks;

		data = {
			artists: null,
			albums: albums,
			tracks: tracks
		}

		_callback(data);
		
	});
}

exports.getTrack = function(storeId, _callback){
	playMusic.getStreamUrl(storeId, function(err, res){
		_callback(res);
	});
}


//var exports = module.exports = playMusic;